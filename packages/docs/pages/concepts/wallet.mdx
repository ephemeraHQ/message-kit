# Agent Wallet

The `WalletService` class in MessageKit provides a way to create an agent wallet for each user that can perform gasless payments and transfers on Base.

## Introduction

To use the `WalletService`, you need to initialize it with a Redis client:

### Requirements

- `@coinbase/coinbase-sdk`: Already included in MessageKit
- `@redis/client`: A Redis client for wallet storage
- Environment variables:
  - `COINBASE_API_KEY_NAME`: The Coinbase API key name
  - `COINBASE_API_KEY_PRIVATE_KEY`: The Coinbase API private key
  - `COINBASE_API_REDIS_URL`: The Redis URL

### Activation

Start by importing the `getWalletService` function from the `redis.js` file:

```typescript
import { getWalletService } from "./lib/redis.js";
const walletServiceDB = await getWalletService();
run(
  async (context: XMTPContext) => {
    // ...
  },
  { walletServiceDB },
);
```

### Usage

The `walletService` object is available in the `context` object:

```typescript
const { walletService } = context;
```

## User Wallets

### Creating and Retrieving a Wallet

The `getUserWallet` method will either retrieve an existing wallet or create a new one:

```typescript
const userWallet = await walletService.getUserWallet(userAddress);
console.log("User wallet data:", userWallet);
// Returns { data: WalletData, address: string }
```

### Checking Balance

```typescript
const balance = await walletService.checkBalance(walletData);
console.log("Wallet balance:", balance); // Returns number in USDC
```

### Transferring Funds

```typescript
await walletService.transfer(fromWalletData, toWalletData, amount);
```

### Withdrawing Funds

```typescript
// Withdraw specific amount
await walletService.withdrawFunds(walletData, userAddress, amount);

// Withdraw entire balance
await walletService.withdrawFunds(walletData, userAddress);
```

### Swapping Assets

```typescript
await walletService.swap(walletData, fromAssetId, toAssetId, amount);
// Returns void, logs trade status on completion
```

## Temporary Wallets

### Creating a Temporary Wallet

```typescript
const tempWallet = await walletService.createTempWallet(tempId);
// Returns { data: WalletData, address: string }
```

### Retrieving a Temporary Wallet

```typescript
const tempWallet = await walletService.getTempWallet(tempId);
```

### Deleting a Temporary Wallet

```typescript
await walletService.deleteTempWallet(tempId);
```

### Requesting Funds

When a user needs funds, you can use the requestFunds helper:

```typescript
await walletService.requestFunds(context, amount, toAddress);
// Sends DM to user with payment request and instructions
```

## Encryption

The WalletService uses a simple but effective encryption system to protect wallet data. The encryption is performed using XOR operations with a key derived from the user's address or provided encryption key.

### Encryption Methods

```typescript
// Encrypt data
const encrypted = WalletService.encrypt(data);

// Decrypt data
const decrypted = WalletService.decrypt(encryptedData);
```

The encryption process:

1. Converts the data to a JSON string
2. Creates a key by hashing the encryption key with keccak256
3. Performs XOR encryption using the hashed key
4. Returns the encrypted data as a hex string

For user wallets, the user's address is used as both the data identifier and encryption key. For temporary wallets, a separate encryption key must be provided.

### Security Considerations

- The encryption key should be kept secure and not shared
- For user wallets, the encryption is tied to their Ethereum address
- Failed decryption will throw an "Invalid wallet access" error
